<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stream Extraction Test - AV Library</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f6f2; padding: 20px; }
        .container { max-width: 900px; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Jable.tv æµåª’é«”é€£çµæå–æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h3>æ¸¬è©¦é…ç½®</h3>
            <div class="mb-3">
                <label for="videoUrl" class="form-label">å½±ç‰‡ URL:</label>
                <input type="text" id="videoUrl" class="form-control" value="https://jable.tv/s0/videos/ssni-865/" placeholder="è¼¸å…¥å½±ç‰‡ URL">
            </div>
            <button class="btn btn-primary" onclick="testExtraction()">é–‹å§‹æ¸¬è©¦</button>
            <button class="btn btn-secondary ms-2" onclick="testWithRawFetch()">ä½¿ç”¨ç›´æ¥ Fetch æ¸¬è©¦</button>
            <button class="btn btn-danger ms-2" onclick="testWithNetworkMonitor()">ç›£è½ç¶²è·¯è«‹æ±‚</button>
            <button class="btn btn-success ms-2" onclick="testInBrowser()">åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œ</button>
            <button class="btn btn-info ms-2" onclick="searchInPreview()">åœ¨é è¦½ä¸­æœå°‹æµ</button>
            <button class="btn btn-secondary ms-2" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div class="test-section">
            <h3>æ¸¬è©¦æ—¥èªŒ</h3>
            <div id="log" style="max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>

        <div class="test-section">
            <h3>æå–çµæœ</h3>
            <div id="results"></div>
        </div>

        <div class="test-section">
            <h3>åŸå§‹ HTML é è¦½</h3>
            <div id="htmlPreview" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-break: break-all;"></div>
        </div>

        <div class="test-section">
            <h3>è¦–é »æ’­æ”¾å™¨æ¸¬è©¦</h3>
            <div id="playerSection" style="display: none;">
                <button class="btn btn-success mb-3" onclick="testPlayback()">æ¸¬è©¦æ’­æ”¾</button>
                <video id="testPlayer" width="100%" height="400" controls style="background: black; border-radius: 4px; display: none;"></video>
                <div id="playerLog" style="margin-top: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f5f5f5; padding: 10px; border-radius: 4px;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentStreams = [];

        const log = (message, type) => {
            type = type || 'info';
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += '<div class="' + className + '">[' + timestamp + '] ' + message + '</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        const clearLog = () => {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        };

        const extractStreamFromHtml = (html) => {
            log('é–‹å§‹åˆ†æ HTML...', 'info');
            const streams = [];

            // æª¢æŸ¥æ˜¯å¦æœ‰ blob URLï¼ˆèªªæ˜ JavaScript è¢«åŸ·è¡Œäº†æˆ–é é¢éœ€è¦ JSï¼‰
            const blobUrls = html.match(/blob:[^\s"'<>]+/g);
            if (blobUrls) {
                log('âš ï¸ æ‰¾åˆ° blob URLï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰ï¼š' + blobUrls[0], 'error');
                log('âš ï¸ é€™è¡¨ç¤ºæµ URL æ˜¯ç”± JavaScript å‹•æ…‹ç”Ÿæˆçš„ï¼Œéœ€è¦åŸ·è¡Œ JS ä»£ç¢¼', 'error');
            }

            // ç­–ç•¥ 1: æœå°‹ hlsUrl JavaScript è®Šæ•¸ (æœ€ç›´æ¥)
            log('ç­–ç•¥ 1: æœå°‹ hlsUrl è®Šæ•¸...', 'info');
            const hlsMatch = html.match(/var\s+hlsUrl\s*=\s*['"]([^'"]+\.m3u8[^'"]*)['"]/i);
            if (hlsMatch && hlsMatch[1]) {
                streams.push({ source: 'hlsUrl', url: hlsMatch[1], method: 1, priority: 0.5 });
                log('âœ“ æ‰¾åˆ° hlsUrl: ' + hlsMatch[1].substring(0, 100) + '...', 'success');
            }

            // ç­–ç•¥ 1b: æ›¿ä»£ hlsUrl æ¨¡å¼
            const hlsMatch2 = html.match(/hlsUrl\s*[:=]\s*['"]([^'"]+\.m3u8[^'"]*)['"]/i);
            if (hlsMatch2 && hlsMatch2[1] && !streams.find(s => s.url === hlsMatch2[1])) {
                streams.push({ source: 'hlsUrl_alt', url: hlsMatch2[1], method: 1, priority: 0.7 });
                log('âœ“ æ‰¾åˆ° hlsUrl (æ›¿ä»£): ' + hlsMatch2[1].substring(0, 100) + '...', 'success');
            }

            // ç­–ç•¥ 2: æœå°‹ poster å±¬æ€§ä¸­çš„åœ–ç‰‡ URL
            log('ç­–ç•¥ 2: æœå°‹ poster å±¬æ€§...', 'info');
            const posterMatch = html.match(/poster="([^"]+)"/);
            if (posterMatch) {
                log('âœ“ æ‰¾åˆ° poster: ' + posterMatch[1], 'success');
            }

            // ç­–ç•¥ 3: åœ¨ JavaScript é…ç½®ä¸­å°‹æ‰¾æµæº
            log('ç­–ç•¥ 3: åœ¨ JavaScript é…ç½®ä¸­æœå°‹...', 'info');
            const jsSourcePatterns = [
                /sources\s*:\s*\[\s*\{\s*src\s*:\s*["']([^"']+)["']/i,
                /mp\.options\.sources.*?src\s*:\s*["']([^"']+)["']/i,
                /"url"\s*:\s*["']([^"']+\.(?:m3u8|mp4))["']/i,
                /'url'\s*:\s*["']([^"']+\.(?:m3u8|mp4))["']/i,
                /src\s*:\s*["'](https?:\/\/[^"']+\.(?:m3u8|mp4))["']/i
            ];

            for (let pattern of jsSourcePatterns) {
                const match = html.match(pattern);
                if (match && match[1]) {
                    const url = match[1];
                    if (!streams.find(s => s.url === url)) {
                        streams.push({ source: 'js_config', url: url, method: 3, priority: 2 });
                        log('âœ“ åœ¨ JS é…ç½®ä¸­æ‰¾åˆ°: ' + url.substring(0, 100) + '...', 'success');
                    }
                }
            }

            // ç­–ç•¥ 4: å°‹æ‰¾ m3u8 é€£çµ
            log('ç­–ç•¥ 4: æœå°‹ç›´æ¥ m3u8 URL...', 'info');
            const m3u8Direct = html.match(/https?:\/\/[^\s"'<>]*\.m3u8[^\s"'<>]*/i);
            if (m3u8Direct) {
                const url = m3u8Direct[0].replace(/[;'"]$/, '');
                if (!streams.find(s => s.url === url)) {
                    streams.push({ source: 'm3u8', url: url, method: 4, priority: 1 });
                    log('âœ“ æ‰¾åˆ°ç›´æ¥ m3u8: ' + url.substring(0, 100) + '...', 'success');
                }
            }

            // ç­–ç•¥ 5: åœ¨æ‰€æœ‰ URL ä¸­æœå°‹æ½›åœ¨çš„æµ
            log('ç­–ç•¥ 5: æœå°‹æ½›åœ¨æµ URL æ¨¡å¼...', 'info');
            const cdnPatterns = [
                /https?:\/\/[^\s"'<>]*cdn[^\s"'<>]*\.(?:m3u8|mp4)/gi,
                /https?:\/\/[^\s"'<>]*stream[^\s"'<>]*\.(?:m3u8|mp4)/gi,
                /https?:\/\/[^\s"'<>]*video[^\s"'<>]*\.(?:m3u8|mp4)/gi
            ];

            for (let pattern of cdnPatterns) {
                let match;
                while ((match = pattern.exec(html)) !== null) {
                    const url = match[0].replace(/["';]$/, '');
                    if (!streams.find(s => s.url === url)) {
                        streams.push({ source: 'cdn', url: url, method: 5, priority: 3 });
                        log('âœ“ æ‰¾åˆ° CDN URL: ' + url.substring(0, 100) + '...', 'success');
                    }
                }
            }

            // ç­–ç•¥ 6: å»£æ³›æœå°‹æ‰€æœ‰ m3u8
            log('ç­–ç•¥ 6: å»£æ³›æœå°‹æ‰€æœ‰ m3u8...', 'info');
            const m3u8Pattern = /https?:\/\/[^\s"'<>]+\.m3u8(?:[^\s"'<>]*)?/gi;
            let match;
            let count = 0;
            while ((match = m3u8Pattern.exec(html)) !== null) {
                const url = match[0].replace(/["';]$/, '');
                if (url && url.endsWith('.m3u8')) {
                    if (!streams.find(s => s.url === url)) {
                        streams.push({ source: 'm3u8', url: url, method: 6, priority: 2 + count });
                        log('âœ“ å»£æ³›æœå°‹ M3U8 ' + (++count) + ': ' + url.substring(0, 80) + '...', 'success');
                    }
                }
            }

            // ç­–ç•¥ 7: æœå°‹ .ts æ–‡ä»¶ä¸¦æ¨æ–· m3u8 è·¯å¾‘
            log('ç­–ç•¥ 7: æœå°‹ .ts æ–‡ä»¶ä¸¦æ¨æ–· m3u8...', 'info');
            const tsMatch = html.match(/https?:\/\/[^\s"'<>]*\/(vod\/\d+\/\d+\/)\d+\.ts[^\s"'<>]*/i);
            if (tsMatch) {
                const baseUrl = tsMatch[0].split('/').slice(0, -1).join('/');
                const m3u8Url = baseUrl + '/playlist.m3u8';
                if (!streams.find(s => s.url === m3u8Url)) {
                    streams.push({ source: 'ts_inferred', url: m3u8Url, method: 7, priority: 1.5 });
                    log('âœ“ å¾ TS æ¨æ–· M3U8: ' + m3u8Url.substring(0, 100) + '...', 'success');
                }
            }

            // ç­–ç•¥ 8: æœå°‹æ‰€æœ‰ MP4
            log('ç­–ç•¥ 8: æœå°‹ MP4 é€£çµ...', 'info');
            const mp4Regex = /https?:\/\/[^\s"'<>]+\.mp4/gi;
            const mp4Matches = html.match(mp4Regex) || [];
            log('æ‰¾åˆ° ' + mp4Matches.length + ' å€‹ MP4 é€£çµ', 'info');
            
            for (let i = 0; i < mp4Matches.length && i < 5; i++) {
                if (!streams.find(s => s.url === mp4Matches[i])) {
                    streams.push({ source: 'mp4', url: mp4Matches[i], method: 8, priority: 7 + i });
                    log('âœ“ MP4 ' + (i + 1) + ': ' + mp4Matches[i].substring(0, 80) + '...', 'success');
                }
            }

            // ç­–ç•¥ 9: æœå°‹ Blob URL ä¸¦åˆ†æé™„è¿‘çš„ JavaScript ä»£ç¢¼
            log('ç­–ç•¥ 9: åˆ†æ Blob URL é™„è¿‘çš„ä»£ç¢¼...', 'info');
            const blobPattern = /blob:[^\s"'<>]+/;
            if (blobPattern.test(html)) {
                log('âš ï¸ æª¢æ¸¬åˆ° blob URL - é€™è¡¨ç¤ºé é¢ä½¿ç”¨ JavaScript å‹•æ…‹åŠ è¼‰æµ', 'error');
                log('éœ€è¦åŸ·è¡Œ JavaScript æˆ–å°‹æ‰¾ JavaScript ä¸­çš„åŸå§‹æµ URL', 'error');
                
                // å˜—è©¦å¾ blob URL é™„è¿‘æå–ä¿¡æ¯
                const blobContext = html.match(/blob:[^\s"'<>]+[^<]*{[^}]*}/);
                if (blobContext) {
                    log('æ‰¾åˆ° blob ä¸Šä¸‹æ–‡: ' + blobContext[0].substring(0, 200), 'info');
                }
            }

            // æ’åºï¼ˆå„ªå…ˆç´šé«˜åœ¨å‰ï¼‰
            streams.sort((a, b) => a.priority - b.priority);

            log('====== ç¸½è¨ˆ: ' + streams.length + ' å€‹æµåª’é«”é€£çµ (å·²æ’åº) ======', 'info');
            return streams;
        };

        const testExtraction = async () => {
            clearLog();
            const videoUrl = document.getElementById('videoUrl').value;
            
            if (!videoUrl) {
                log('è«‹è¼¸å…¥å½±ç‰‡ URL', 'error');
                return;
            }

            log('é–‹å§‹æ¸¬è©¦: ' + videoUrl, 'info');

            try {
                // å˜—è©¦æ–¹æ³• 1: æ¨™æº– Jina
                log('æ–¹æ³• 1: ä½¿ç”¨æ¨™æº– Jina ä»£ç†', 'info');
                let jinaUrl = 'https://r.jina.ai/' + videoUrl;
                let html = await fetchFromJinaWithHtmlMode(jinaUrl);
                
                if (!html || html.includes('Markdown Content:')) {
                    log('âš ï¸ æ¨™æº–æ–¹æ³•è¿”å› Markdownï¼Œå˜—è©¦ HTML æ¨¡å¼...', 'error');
                    
                    // å˜—è©¦æ–¹æ³• 2: æ·»åŠ  ?Accept=text/html
                    log('æ–¹æ³• 2: è«‹æ±‚ HTML æ ¼å¼...', 'info');
                    jinaUrl = 'https://r.jina.ai/' + videoUrl + '?Accept=text/html';
                    html = await fetchFromJinaWithHtmlMode(jinaUrl);
                }
                
                if (!html) {
                    throw new Error('ç„¡æ³•å¾ Jina ç²å–å…§å®¹');
                }

                log('âœ“ æˆåŠŸç²å–é é¢ (' + html.length + ' å­—å…ƒ)', 'success');

                // é¡¯ç¤ºåŸå§‹ HTML
                const preview = document.getElementById('htmlPreview');
                preview.textContent = html.substring(0, 3000);

                // æª¢æŸ¥å…§å®¹æ ¼å¼
                if (html.includes('<') && html.includes('>')) {
                    log('âœ… æª¢æ¸¬åˆ° HTML æ ¼å¼', 'success');
                } else if (html.includes('Markdown Content:')) {
                    log('âš ï¸ ä»ç„¶æ˜¯ Markdown æ ¼å¼', 'error');
                    log('å‰ 500 å­—: ' + html.substring(0, 500), 'info');
                } else {
                    log('âš ï¸ æœªçŸ¥æ ¼å¼', 'error');
                }

                const streams = extractStreamFromHtml(html);
                currentStreams = streams;
                displayResults(streams);

            } catch (error) {
                log('âœ— éŒ¯èª¤: ' + error.message, 'error');
            }
        };

        const fetchFromJinaWithHtmlMode = async (jinaUrl) => {
            try {
                const response = await fetch(jinaUrl, {
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return await response.text();
            } catch (error) {
                log('Jina è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
                return null;
            }
        };

        const testWithRawFetch = async () => {
            clearLog();
            const videoUrl = document.getElementById('videoUrl').value;
            
            if (!videoUrl) {
                log('è«‹è¼¸å…¥å½±ç‰‡ URL', 'error');
                return;
            }

            log('é–‹å§‹ç›´æ¥ Fetch æ¸¬è©¦: ' + videoUrl, 'info');

            try {
                log('æ­£åœ¨å˜—è©¦ç›´æ¥ fetch...', 'info');
                
                const response = await fetch(videoUrl, {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                const html = await response.text();
                log('âœ“ æˆåŠŸç›´æ¥ç²å–é é¢ (' + html.length + ' å­—å…ƒ)', 'success');

                const streams = extractStreamFromHtml(html);
                currentStreams = streams;
                displayResults(streams);

            } catch (error) {
                log('âœ— ç›´æ¥ fetch å¤±æ•—: ' + error.message + ', å˜—è©¦ Jina ä»£ç†...', 'error');
                testExtraction();
            }
        };

        const displayResults = (streams) => {
            const resultsDiv = document.getElementById('results');
            
            if (streams.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">æœªæ‰¾åˆ°ä»»ä½•æµåª’é«”é€£çµ</div>';
                return;
            }

            let html = '<div class="alert alert-success">æ‰¾åˆ° ' + streams.length + ' å€‹æµåª’é«”é€£çµ</div>';
            
            // M3U8 é€£çµ
            const m3u8Links = streams.filter((s) => s.url.includes('.m3u8'));
            if (m3u8Links.length > 0) {
                html += '<h5>M3U8 é€£çµ (æ¨è–¦ç”¨æ–¼æ’­æ”¾)</h5>';
                for (let i = 0; i < m3u8Links.length; i++) {
                    const link = m3u8Links[i];
                    const idx = streams.indexOf(link);
                    html += '<div style="margin: 5px 0; padding: 10px; background: #e3f2fd; border-left: 4px solid #1976d2; border-radius: 4px;">' +
                        '<small><strong>æ–¹æ³• ' + link.method + ' (' + link.source + '):</strong></small><br>' +
                        '<code style="word-break: break-all; font-size: 11px;">' + link.url + '</code><br>' +
                        '<button class="btn btn-sm btn-primary" onclick="handleTestStream(' + idx + ')">æ¸¬è©¦æ’­æ”¾</button> ' +
                        '<button class="btn btn-sm btn-secondary" onclick="handleCopyUrl(' + idx + ')">è¤‡è£½ URL</button>' +
                        '</div>';
                }
            }
            
            // å…¶ä»–é€£çµ
            const otherLinks = streams.filter((s) => !s.url.includes('.m3u8'));
            if (otherLinks.length > 0) {
                html += '<hr><h5>å…¶ä»–é€£çµ</h5>';
                html += '<table class="table table-sm table-bordered">' +
                    '<thead><tr><th>æ–¹æ³•</th><th>ä¾†æº</th><th>URL</th><th>æ“ä½œ</th></tr></thead>' +
                    '<tbody>';
                
                for (let i = 0; i < otherLinks.length; i++) {
                    const stream = otherLinks[i];
                    const idx = streams.indexOf(stream);
                    const shortUrl = stream.url.substring(0, 50) + (stream.url.length > 50 ? '...' : '');
                    html += '<tr>' +
                        '<td>' + stream.method + '</td>' +
                        '<td>' + stream.source + '</td>' +
                        '<td title="' + stream.url + '"><small>' + shortUrl + '</small></td>' +
                        '<td>' +
                        '<button class="btn btn-sm btn-primary" onclick="handleTestStream(' + idx + ')">æ¸¬è©¦</button> ' +
                        '<button class="btn btn-sm btn-secondary" onclick="handleCopyUrl(' + idx + ')">è¤‡è£½</button>' +
                        '</td>' +
                        '</tr>';
                }
                
                html += '</tbody></table>';
            }

            resultsDiv.innerHTML = html;
            document.getElementById('playerSection').style.display = 'block';
        };

        const handleTestStream = (idx) => {
            if (idx >= 0 && idx < currentStreams.length) {
                testStream(currentStreams[idx].url, idx);
            }
        };

        const handleCopyUrl = (idx) => {
            if (idx >= 0 && idx < currentStreams.length) {
                copyToClipboard(currentStreams[idx].url);
            }
        };

        const testStream = async (url, idx) => {
            const playerLog = document.getElementById('playerLog');
            playerLog.innerHTML = '';

            const logPlayer = (msg, type) => {
                type = type || 'info';
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
                playerLog.innerHTML += '<div class="' + className + '">' + msg + '</div>';
            };

            logPlayer('æ¸¬è©¦æµ #' + (idx + 1) + ': ' + url.substring(0, 80) + '...', 'info');

            const player = document.getElementById('testPlayer');
            player.style.display = 'block';
            
            try {
                logPlayer('æ­£åœ¨æª¢æŸ¥ URL å¯è¨ªå•æ€§...', 'info');
                const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                logPlayer('âœ“ URL å¯è¨ªå• (ç‹€æ…‹: ' + response.status + ')', 'success');

                logPlayer('æ­£åœ¨è¨­ç½®æ’­æ”¾å™¨...', 'info');
                player.src = url;
                logPlayer('âœ“ æ’­æ”¾å™¨å·²è¨­ç½®', 'success');
                logPlayer('æ‚¨å¯ä»¥é»æ“Šæ’­æ”¾æŒ‰éˆ•å˜—è©¦æ’­æ”¾', 'info');

            } catch (error) {
                logPlayer('âœ— éŒ¯èª¤: ' + error.message, 'error');
            }
        };

        const testPlayback = () => {
            const player = document.getElementById('testPlayer');
            if (!player.src) {
                alert('è«‹å…ˆæ¸¬è©¦ä¸€å€‹æµé€£çµ');
                return;
            }
            player.play().catch((err) => {
                alert('æ’­æ”¾å¤±æ•—: ' + err.message);
            });
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch((err) => {
                alert('è¤‡è£½å¤±æ•—: ' + err.message);
            });
        };

        const testInBrowser = async () => {
            clearLog();
            const videoUrl = document.getElementById('videoUrl').value;
            
            if (!videoUrl) {
                log('è«‹è¼¸å…¥å½±ç‰‡ URL', 'error');
                return;
            }

            log('åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œæ¸¬è©¦: ' + videoUrl, 'info');
            log('ğŸ’¡ æ­¤æ–¹æ³•æ‰“é–‹æ–°çª—å£ï¼Œè‡ªå‹•å¾é é¢è¤‡è£½ hlsUrl åˆ°å‰ªè²¼ç°¿', 'info');

            try {
                // æ‰“é–‹ä¸€å€‹æ–°çª—å£
                const popup = window.open(videoUrl, '_blank', 'width=1024,height=768');
                
                if (!popup) {
                    log('âŒ ç„¡æ³•æ‰“é–‹æ–°çª—å£ï¼ˆå¯èƒ½è¢«ç€è¦½å™¨é˜»æ­¢ï¼‰', 'error');
                    return;
                }

                log('âœ“ æ–°çª—å£å·²æ‰“é–‹', 'success');

                // ç­‰å¾…æ–°çª—å£åŠ è¼‰
                let retries = 0;
                const maxRetries = 40; // 20 ç§’

                const checkInterval = setInterval(async () => {
                    retries++;
                    
                    if (popup.closed) {
                        clearInterval(checkInterval);
                        return;
                    }

                    // ç­‰å¾…çª—å£å®Œå…¨åŠ è¼‰
                    if (popup.document && popup.document.readyState === 'complete') {
                        try {
                            // åœ¨æ–°çª—å£ä¸­åŸ·è¡Œè…³æœ¬
                            const extractAndCopy = `
                                (async () => {
                                    let hlsUrl = null;

                                    // æ–¹æ³• 1: ç›´æ¥è¨ªå•
                                    if (typeof window.hlsUrl !== 'undefined' && window.hlsUrl) {
                                        hlsUrl = window.hlsUrl;
                                        console.log('âœ… æ‰¾åˆ° hlsUrl (ç›´æ¥):', hlsUrl);
                                    }

                                    // æ–¹æ³• 2: å¾ script æ¨™ç±¤æœå°‹
                                    if (!hlsUrl) {
                                        const scripts = document.querySelectorAll('script');
                                        for (let script of scripts) {
                                            const match = script.textContent.match(/hlsUrl\\s*=\\s*['"]([^'"]+\\.m3u8[^'"]*)['"]/i);
                                            if (match && match[1]) {
                                                hlsUrl = match[1];
                                                console.log('âœ… æ‰¾åˆ° hlsUrl (script æ¨™ç±¤):', hlsUrl);
                                                break;
                                            }
                                        }
                                    }

                                    // æ–¹æ³• 3: æœå°‹å…¨å±€è®Šæ•¸
                                    if (!hlsUrl) {
                                        for (let key in window) {
                                            try {
                                                if (typeof window[key] === 'string' && window[key].includes('.m3u8')) {
                                                    hlsUrl = window[key];
                                                    console.log('âœ… æ‰¾åˆ° hlsUrl (å…¨å±€è®Šæ•¸ ' + key + '):', hlsUrl);
                                                    break;
                                                }
                                            } catch (e) {}
                                        }
                                    }

                                    if (hlsUrl) {
                                        try {
                                            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
                                            await navigator.clipboard.writeText(hlsUrl);
                                            console.log('âœ“ URL å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                                            
                                            // åœ¨é é¢ä¸Šé¡¯ç¤º
                                            const div = document.createElement('div');
                                            div.style.cssText = 'position:fixed;top:10px;left:10px;background:#4CAF50;color:white;padding:15px;border-radius:5px;z-index:999999;font-size:14px;max-width:400px;word-break:break-all;';
                                            div.innerHTML = 'âœ… hlsUrl å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼<br><small>' + hlsUrl.substring(0, 100) + '...</small>';
                                            document.body.appendChild(div);
                                            
                                            setTimeout(() => div.remove(), 5000);
                                        } catch (err) {
                                            console.log('è¤‡è£½å¤±æ•—:', err);
                                        }
                                    } else {
                                        console.log('âŒ æœªæ‰¾åˆ° hlsUrl');
                                        const div = document.createElement('div');
                                        div.style.cssText = 'position:fixed;top:10px;left:10px;background:#f44336;color:white;padding:15px;border-radius:5px;z-index:999999;font-size:14px;';
                                        div.innerHTML = 'âŒ æœªæ‰¾åˆ° hlsUrlï¼Œè«‹ç¨å€™å†è©¦...';
                                        document.body.appendChild(div);
                                        setTimeout(() => div.remove(), 3000);
                                    }
                                })();
                            `;

                            popup.eval(extractAndCopy);
                            clearInterval(checkInterval);
                            
                            log('âœ“ å·²åœ¨æ–°çª—å£åŸ·è¡Œæå–è…³æœ¬', 'success');
                            log('å¦‚æœ URL æ‰¾åˆ°ï¼Œæœƒè‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'info');
                            log('è«‹åœ¨ä¸‹æ–¹è¼¸å…¥æ¡†ç²˜è²¼ (Ctrl+V):', 'info');
                            
                            // é¡¯ç¤ºç²˜è²¼å€åŸŸ
                            const pasteSection = document.createElement('div');
                            pasteSection.className = 'test-section';
                            pasteSection.innerHTML = `
                                <h4>ç²˜è²¼æå–çš„ URL:</h4>
                                <textarea id="pasteUrl" class="form-control mb-2" rows="3" placeholder="ç²˜è²¼å¾æ–°çª—å£è¤‡è£½çš„ hlsUrl..."></textarea>
                                <button class="btn btn-success" onclick="handlePastedUrl()">ç¢ºèªä½¿ç”¨æ­¤ URL</button>
                            `;
                            
                            const resultsDiv = document.getElementById('results');
                            if (resultsDiv) {
                                resultsDiv.innerHTML = '';
                                resultsDiv.parentElement.insertBefore(pasteSection, resultsDiv);
                            }
                            
                            return;
                        } catch (error) {
                            if (retries >= maxRetries) {
                                clearInterval(checkInterval);
                                log('âŒ ç„¡æ³•åŸ·è¡Œ: ' + error.message, 'error');
                                log('è«‹æ‰‹å‹•åœ¨æ–°çª—å£åŸ·è¡Œ:', 'info');
                                log('navigator.clipboard.writeText(window.hlsUrl)', 'info');
                            }
                        }
                    } else {
                        if (retries % 8 === 0) {
                            log('â³ ç­‰å¾…é é¢åŠ è¼‰... (' + Math.floor(retries * 0.5) + 'ç§’)', 'info');
                        }
                    }
                }, 500);

                // 20 ç§’å¾Œåœæ­¢æª¢æŸ¥
                setTimeout(() => {
                    if (!popup.closed) {
                        clearInterval(checkInterval);
                        log('â±ï¸ æª¢æŸ¥è¶…æ™‚', 'error');
                        log('æ‰‹å‹•æ–¹æ³•: åœ¨æ–°çª—å£æ§åˆ¶å°åŸ·è¡Œ:', 'info');
                        log('navigator.clipboard.writeText(window.hlsUrl)', 'info');
                    }
                }, 20000);

            } catch (error) {
                log('âœ— éŒ¯èª¤: ' + error.message, 'error');
            }
        };

        const handlePastedUrl = () => {
            const url = document.getElementById('pasteUrl').value.trim();
            if (!url) {
                alert('è«‹ç²˜è²¼ URL');
                return;
            }

            currentStreams = [{
                source: 'hlsUrl (from browser)',
                url: url,
                method: 'browser',
                priority: 0
            }];

            displayResults(currentStreams);
            document.getElementById('pasteUrl').closest('.test-section').style.display = 'none';
        };

        window.addEventListener('load', () => {
            log('æ¸¬è©¦å·¥å…·å·²å°±ç·’', 'success');
            log('è¼¸å…¥å½±ç‰‡ URL ä¸¦é»æ“Šã€Œé–‹å§‹æ¸¬è©¦ã€', 'info');
            log('æˆ–ä½¿ç”¨ã€Œåœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œã€ç›´æ¥å¾é é¢ç²å– hlsUrl', 'info');
        });

        const searchInPreview = () => {
            const preview = document.getElementById('htmlPreview');
            const searchTerm = prompt('æœå°‹é—œéµå­— (ä¾‹å¦‚: m3u8, mp4, source, cdn):');
            if (!searchTerm) return;

            const text = preview.textContent;
            const regex = new RegExp(`[^\\s"'<>]*${searchTerm}[^\\s"'<>]*`, 'gi');
            const matches = text.match(regex) || [];
            
            const uniqueMatches = [...new Set(matches)];
            log(`åœ¨é è¦½ä¸­æ‰¾åˆ° ${uniqueMatches.length} å€‹ç›¸é—œçµæœ:`, 'info');
            
            uniqueMatches.forEach((match, i) => {
                if (match.length < 300) {
                    log(`${i + 1}. ${match}`, 'info');
                }
            });
        };

        const testWithNetworkMonitor = async () => {
            clearLog();
            const videoUrl = document.getElementById('videoUrl').value;
            
            if (!videoUrl) {
                log('è«‹è¼¸å…¥å½±ç‰‡ URL', 'error');
                return;
            }

            log('é–‹å§‹ç¶²è·¯ç›£è½æ¸¬è©¦: ' + videoUrl, 'info');
            log('âš ï¸ æ­¤æ–¹æ³•éœ€è¦åœ¨å¯¦éš›ç€è¦½å™¨ä¸­è¨ªå•é é¢', 'error');
            log('ç„¡æ³•åœ¨æ¸¬è©¦å·¥å…·ä¸­ç›´æ¥ç›£è½ï¼Œå»ºè­°æ­¥é©Ÿï¼š', 'info');
            log('1. åœ¨æ–°æ¨™ç±¤é è¨ªå•: ' + videoUrl, 'info');
            log('2. æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·', 'info');
            log('3. åˆ‡æ›åˆ°ã€ŒNetworkã€æ¨™ç±¤', 'info');
            log('4. é‡æ–°åŠ è¼‰é é¢', 'info');
            log('5. å°‹æ‰¾é¡å‹ç‚ºã€ŒXHRã€æˆ–ã€ŒFetchã€çš„è«‹æ±‚ï¼ŒåŒ…å« m3u8 æˆ– mp4', 'info');
            log('6. åœ¨ã€ŒResponseã€ä¸­æŸ¥çœ‹å¯¦éš›æµ URL', 'info');
            log('', 'info');
            log('æˆ–è€…ï¼Œå˜—è©¦åœ¨æ§åˆ¶å°åŸ·è¡Œä»¥ä¸‹ä»£ç¢¼:', 'info');
            
            const code = `
// æˆªå–æ‰€æœ‰ fetch è«‹æ±‚
const originalFetch = window.fetch;
window.fetch = function(...args) {
    console.log('[Fetch Intercept]', args[0]);
    return originalFetch.apply(this, args);
};

// æŸ¥çœ‹æ‰€æœ‰ video å…ƒç´ çš„ src
document.querySelectorAll('video').forEach((v, i) => {
    console.log('Video ' + i + ':', v.src, v.currentSrc);
    if (v.children) {
        [...v.children].forEach(child => {
            console.log('  - Child:', child.src || child.data);
        });
    }
});
            `;
            
            log('ä»£ç¢¼:', 'info');
            log(code, 'info');
        };
    </script>
</body>
</html>
